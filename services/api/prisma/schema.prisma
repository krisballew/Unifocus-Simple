// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

// ============================================================================
// TENANT & ORGANIZATION STRUCTURE
// ============================================================================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Tenant-level settings
  weekStartDay Int    @default(0)    // 0 = Sunday, 1 = Monday, etc.
  defaultLocale String @default("en-US")
  defaultTimezone String @default("UTC")
  defaultCurrency String @default("USD")

  properties  Property[]
  departments Department[]
  jobRoles    JobRole[]
  users       User[]
  employees   Employee[]
  schedules   Schedule[]
  shifts      Shift[]
  punches     Punch[]
  exceptions  Exception[]
  auditLogs   AuditLog[]

  @@index([createdAt])
}

model Property {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  address   String?
  city      String?
  state     String?
  zipCode   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  departments         Department[]
  jobRoles            JobRole[]
  users               User[]
  userRoleAssignments UserRoleAssignment[]
  employees           Employee[]
  schedules           Schedule[]
  auditLogs           AuditLog[]

  @@unique([tenantId, id])
  @@index([tenantId])
  @@index([createdAt])
}

model Department {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  propertyId String
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  name      String
  code      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users               User[]
  userRoleAssignments UserRoleAssignment[]
  jobRoles            JobRole[]
  auditLogs           AuditLog[]

  @@unique([tenantId, propertyId, id])
  @@index([tenantId])
  @@index([propertyId])
  @@index([createdAt])
}

model JobRole {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  propertyId      String
  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  departmentId    String
  department      Department @relation(fields: [departmentId], references: [id], onDelete: Cascade)

  name            String   // Job title (e.g., "Front Desk Associate", "Housekeeper")
  code            String?  // Code for the job role
  masterCategory  String   // Master category for benchmarking/rollup (e.g., "Front Office", "Housekeeping")

  description     String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  employeeJobAssignments EmployeeJobAssignment[]

  @@unique([tenantId, propertyId, departmentId, id])
  @@index([tenantId])
  @@index([propertyId])
  @@index([departmentId])
  @@index([masterCategory])
  @@index([createdAt])
}

// ============================================================================
// USERS & ROLES
// ============================================================================

model User {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  propertyId String?
  property  Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  departmentId String?
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  email     String
  name      String
  password  String?
  isActive  Boolean  @default(true)

  // Password reset tokens
  resetToken String?  @unique
  resetTokenExpiry DateTime?
  inviteToken String?  @unique // Token for completing registration via email invite
  inviteTokenExpiry DateTime?

  // User locale preferences
  locale    String?  // e.g., "en-US", "es-ES" - null means use tenant default
  timezone  String?  // e.g., "America/New_York" - null means use tenant default
  currency  String?  // e.g., "USD", "EUR" - null means use tenant default
  avatarUrl String?  // URL to user avatar image
  defaultPropertyId String?  // Default property for multi-property users
  lastLoginAt DateTime? // Last login timestamp

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  roleAssignments UserRoleAssignment[]
  auditLogs       AuditLog[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([propertyId])
  @@index([departmentId])
  @@index([email])
  @@index([createdAt])
}

model Role {
  id        String   @id @default(cuid())
  name      String   @unique
  description String?
  permissions String[] // JSON array of permission strings
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userAssignments UserRoleAssignment[]

  @@index([createdAt])
}

model UserRoleAssignment {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // Scope: optional property and/or department
  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  departmentId String?
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs AuditLog[]

  @@unique([userId, roleId, propertyId, departmentId])
  @@index([tenantId])
  @@index([userId])
  @@index([roleId])
  @@index([propertyId])
  @@index([departmentId])
  @@index([createdAt])
}

// ============================================================================
// EMPLOYEES & ASSIGNMENTS
// ============================================================================

model Employee {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  propertyId String
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  employeeId String?  // Alpha-numeric employee ID (e.g., "EMP001", "E-0042")
  firstName String
  lastName  String
  email     String?
  phone     String?
  externalId String? // For integration with other systems

  // Organizational Structure - Reporting Hierarchy (multiple managers supported)
  managerLinks EmployeeReport[] @relation("EmployeeManagers")
  directReportLinks EmployeeReport[] @relation("ManagerReports")

  isActive  Boolean  @default(true)
  hireDate  DateTime?

  // Employment Details - Comprehensive record covering 6 domains
  // Stored as JSON: Core Record, Pay & Labor, Scheduling, Compliance, Time & Attendance, Operations
  employmentDetails Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jobAssignments EmployeeJobAssignment[]
  schedules      Schedule[]
  punches        Punch[]
  exceptions     Exception[]
  auditLogs      AuditLog[]

  @@unique([tenantId, propertyId, id])
  @@unique([tenantId, employeeId])
  @@index([tenantId])
  @@index([propertyId])
  @@index([employeeId])
  @@index([email])
  @@index([createdAt])
}

model EmployeeReport {
  id         String   @id @default(cuid())
  tenantId   String
  employeeId String
  managerId  String

  employee Employee @relation("EmployeeManagers", fields: [employeeId], references: [id], onDelete: Cascade)
  manager  Employee @relation("ManagerReports", fields: [managerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([employeeId, managerId])
  @@index([tenantId])
  @@index([employeeId])
  @@index([managerId])
  @@index([createdAt])
}

model EmployeeJobAssignment {
  id              String   @id @default(cuid())
  tenantId        String
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  jobRoleId       String
  jobRole         JobRole  @relation(fields: [jobRoleId], references: [id], onDelete: Cascade)

  // Pay & Labor configuration for this specific job
  payType         String   @default("hourly")  // "hourly", "salary", "tipped"
  hourlyRate      Float?   // Hourly rate for this job
  salaryAmount    Float?   // Annual salary if salaried
  payrollGroup    String?  // Payroll group assignment
  overtimeEligible Boolean @default(true)
  tipPoolEligible Boolean @default(false)

  startDate       DateTime
  endDate         DateTime?
  isPrimary       Boolean  @default(false)     // Primary job role for employee

  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  auditLogs       AuditLog[]

  @@unique([tenantId, employeeId, jobRoleId])
  @@index([tenantId])
  @@index([employeeId])
  @@index([jobRoleId])
  @@index([startDate])
  @@index([createdAt])
}

// ============================================================================
// SCHEDULING
// ============================================================================

model Schedule {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  propertyId String
  property  Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  employeeId String
  employee  Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  name      String?
  startDate DateTime
  endDate   DateTime?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shifts    Shift[]
  auditLogs AuditLog[]

  @@unique([tenantId, propertyId, employeeId, id])
  @@index([tenantId])
  @@index([propertyId])
  @@index([employeeId])
  @@index([startDate])
  @@index([createdAt])
}

model Shift {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  scheduleId String
  schedule  Schedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  dayOfWeek Int      // 0-6, Sunday-Saturday
  startTime String   // HH:MM format
  endTime   String   // HH:MM format
  breakMinutes Int   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  punches   Punch[]
  auditLogs AuditLog[]

  @@unique([tenantId, scheduleId, id])
  @@index([tenantId])
  @@index([scheduleId])
  @@index([createdAt])
}

// ============================================================================
// TIME TRACKING
// ============================================================================

model Punch {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employeeId String
  employee  Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  shiftId   String?
  shift     Shift?   @relation(fields: [shiftId], references: [id], onDelete: SetNull)

  type      String   // "in", "out", "break_start", "break_end"
  timestamp DateTime

  latitude  Float?
  longitude Float?
  deviceId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs AuditLog[]

  @@unique([tenantId, employeeId, id])
  @@index([tenantId])
  @@index([employeeId])
  @@index([shiftId])
  @@index([timestamp])
  @@index([type])
  @@index([createdAt])
}

model Exception {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employeeId String
  employee  Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  type      String   // "absence", "late", "early_out", "manual_adjustment", etc.
  reason    String?
  date      DateTime

  startTime String?  // HH:MM format
  endTime   String?  // HH:MM format

  status    String   @default("pending") // "pending", "approved", "rejected"
  approvedAt DateTime?
  approvedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs AuditLog[]

  @@unique([tenantId, employeeId, id])
  @@index([tenantId])
  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([createdAt])
}

// ============================================================================
// IDEMPOTENCY
// ============================================================================

model IdempotencyRecord {
  id        String   @id @default(cuid())
  tenantId  String
  userId    String?  // Optional: user who made the request
  idempotencyKey String
  endpoint  String   // e.g., "POST /api/punches"

  // Store the response for replay
  statusCode Int
  responseBody String // JSON response

  createdAt DateTime @default(now())
  expiresAt DateTime // Records expire after 24 hours

  @@unique([tenantId, userId, idempotencyKey, endpoint])
  @@index([tenantId])
  @@index([idempotencyKey])
  @@index([expiresAt])
  @@index([createdAt])
}

// ============================================================================
// AUDIT LOG
// ============================================================================

model AuditLog {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userRoleAssignmentId String?
  userRoleAssignment UserRoleAssignment? @relation(fields: [userRoleAssignmentId], references: [id], onDelete: SetNull)

  propertyId String?
  property   Property? @relation(fields: [propertyId], references: [id], onDelete: SetNull)
  departmentId String?
  department Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  employeeJobAssignmentId String?
  employeeJobAssignment EmployeeJobAssignment? @relation(fields: [employeeJobAssignmentId], references: [id], onDelete: SetNull)

  scheduleId String?
  schedule   Schedule? @relation(fields: [scheduleId], references: [id], onDelete: SetNull)
  shiftId    String?
  shift      Shift? @relation(fields: [shiftId], references: [id], onDelete: SetNull)

  punchId    String?
  punch      Punch? @relation(fields: [punchId], references: [id], onDelete: SetNull)
  exceptionId String?
  exception  Exception? @relation(fields: [exceptionId], references: [id], onDelete: SetNull)

  action    String   // "created", "updated", "deleted", etc.
  entity    String   // "User", "Employee", "Shift", etc.
  changes   String?  // JSON object with before/after values

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([propertyId])
  @@index([departmentId])
  @@index([employeeId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
}
